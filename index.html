<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Example Viewer</title>

    <!-- For offline development (first run fetchLibs.sh) -->
    <script src="/libs/d3.min.js"></script>
    <script src="/libs/codemirror.min.js"></script>
    <script src="/libs/javascript.min.js"></script>
    <script src="/libs/css.min.js"></script>
    <script src="/libs/xml.min.js"></script>
    <script src="/libs/htmlmixed.min.js"></script>
    <link rel="stylesheet" href="/libs/codemirror.min.css">
    
    <!-- For cloud hosting -->
    <!--
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/htmlmixed/htmlmixed.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/codemirror.min.css">
    -->

    <style>

      body {
        margin: 0px;
        font-family: Sans-Serif;
      }

      .CodeMirror {
        font-size: 3rem;
        height: auto;
      }

      /* Adds a shadow effect. Inspired by Material Design "Cards". */
      .shadow {
        box-shadow: 1px 1px 4px grey;
      }

      .header {
        margin: 16px;
        font-size: 3rem;
      }
      .header-breadcrumbs {
        color: #999;
      }
      .header-title {
        font-size: 2em;
      }

      .runner {
        position: fixed;
        top: 0px;
        right: 0px;
        background-color: white;
        z-index: 3; /* CodeMirror's z-index is 2. */
      }

      .overlay {
        position: fixed;
        top: 0px;
        bottom: 0px;
        right: 0px;
        left: 0px;
        pointer-events: none;
        z-index: 4; /* Above everything else. */
      }

    </style>
  </head>
  <body>
    <script>
(function (){

  var dispatch = d3.dispatch(
    "htmlFetch", // When the HTML content is fetched from the server.
    "htmlChange", // When the HTML content is changed.
    "save", // When a save was requested.
    "saved", // After a save occurred.
    "navigate" // On navigation (route change).
  );

  var body = d3.select("body");

  Header(body, dispatch);
  Editor(body, dispatch);
  Runner(body, dispatch);
  Overlay(body, dispatch);
  Server(dispatch);
  Keyboard(dispatch);
  Router(dispatch);


  function Header(selection, dispatch){
    var header = selection.append("div").attr("class", "header"),
        breadcrumbs = header.append("div").attr("class", "header-breadcrumbs"),
        title = header.append("div").attr("class", "header-title");

    // TODO make this dynamic.
    breadcrumbs.text("Unit 1 / Module 1 / Example 1");

    dispatch.on("htmlChange.header", function (html){
      title.text(extractTitle(html));
    });

    function extractTitle(html){
      return html.match(/title>(.*?)</)[1];
    }
  }


  function Editor(selection, dispatch){
    var code = selection.append("div").attr("class", "shadow"),
        editor = CodeMirror(code.node(), {
          lineNumbers: false,
          mode: "htmlmixed"
        });

    editor.on("change", function (editor, change){
      if(change.origin === "setValue") return;
      dispatch.call("htmlChange", null, editor.getValue());
    });

    dispatch.on("htmlFetch.editor", function (html){
      editor.setValue(html);
    });
  }


  function Runner(selection, dispatch){
    var iframe = selection.append("iframe").attr("class", "shadow runner")
      .attr("width", "960") // 960 X 500 is standard for bl.ocks.org.
      .attr("height", "500")
      .attr("marginwidth", "0") // Have no margin to match with bl.ocks.org.
      .attr("marginheight", "0")
      .attr("frameborder", "0px")
      .attr("scrolling", "no");

    dispatch.on("htmlChange.runner", function (html){
      iframe.attr("srcdoc", html);
    });
  }

  
  function Overlay(selection, dispatch){
    var div = selection.append("div").attr("class", "overlay"),
        svg = div.append("svg");

    function notify(message){
      var width = div.node().clientWidth,
          height = div.node().clientHeight;
      svg
          .attr("width", width)
          .attr("height", height)
        .append("text")
          .attr("x", width / 2)
          .attr("y", height / 2)
          .attr("text-anchor", "middle")
          .attr("alignment-baseline", "middle")
          .style("text-shadow", "0px 0px 5px white")
          .attr("font-size", "20em")
          .attr("opacity", 1)
          .text(message)
        .transition().duration(700).ease(d3.easeLinear)
          .attr("font-size", "23em")
          .attr("opacity", 0)
          .remove();
    }
    
    dispatch.on("saved.overlay", function (){
      notify("Saved!");
    });
  }


  function Server(dispatch){
    d3.request("example.html").get(function (xhr){
      var html = xhr.responseText;
      dispatch.call("htmlFetch", null, html);
      dispatch.call("htmlChange", null, html);
    });

    dispatch.on("save.server", function (data){
      d3.request("save")
        .header("Content-Type", "application/json")
        .post(JSON.stringify(data), function (){
          dispatch.call("saved");
        });
    });
  }


  function Keyboard(dispatch){

    // Track the current state of the HTML content.
    var html = "";
    dispatch.on("htmlChange.keyboard", function (_){
      html = _;
    });

    // Listen for global key presses.
    window.addEventListener("keydown", function (event){
      var S = 83;

      // Save the content to the server on CTRL + S
      if(event.ctrlKey && event.which === S){

        // Without this, the browser will try to save the page.
        event.preventDefault();

        dispatch.call("save", null, {
          content: html
        });
      }
    });
  }


  function Router(dispatch){
    var defaultParams = { unit: 1, module: 1, example: 1, };

    window.addEventListener("hashchange", navigate);
    navigate();

    function navigate(){
      var params = parseHash();
      if(params){
        dispatch.call("navigate", null, params);
      } else {
        location.hash = encodeHash(defaultParams);
      }
    }

    function parseHash(){
      var path = location.hash.substr(1).split("/");
      if(path.length === 3){
        return { unit: path[0], module: path[1], example: path[2] };
      }
      return null;
    }

    function encodeHash(params){
      return "#" + params.unit + "/" + params.module + "/" + params.example;
    }
  }

}());

    </script>
  </body>
</html>
