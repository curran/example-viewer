<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Example Viewer</title>

    <!-- For offline development (first run fetchLibs.sh) -->
    <script src="/libs/d3.min.js"></script>
    <script src="/libs/codemirror.min.js"></script>
    <script src="/libs/javascript.min.js"></script>
    <script src="/libs/css.min.js"></script>
    <script src="/libs/xml.min.js"></script>
    <script src="/libs/htmlmixed.min.js"></script>
    <link rel="stylesheet" href="/libs/codemirror.min.css">
    
    <!-- For cloud hosting -->
    <!--
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/mode/htmlmixed/htmlmixed.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.23.0/codemirror.min.css">
    -->

    <style>

      body {
        margin: 0px;
      }

      .CodeMirror {
        font-size: 3rem;
        height: auto;
      }

    </style>
  </head>
  <body>
    <script>
(function (){

  var body = d3.select("body");
  var dispatch = d3.dispatch("htmlChange", "htmlFetch");

  Header(body, dispatch);
  Editor(body, dispatch);
  Runner(body, dispatch);
  Server(dispatch);


  function Header(selection, dispatch){
    var header = selection.append("div")
          .style("margin", "16px")
          .style("font-size", "3rem")
          .style("font-family", "Sans-Serif"),
        breadcrumbs = header.append("div")
          .style("color", "#999"),
        title = header.append("div")
          .style("font-size", "2em");

    // TODO make this dynamic.
    breadcrumbs.text("Unit 1 / Module 1 / Example 1");

    dispatch.on("htmlChange.header", function (html){
      title.text(extractTitle(html));
    });

    function extractTitle(html){
      return html.match(/title>(.*?)</)[1];
    }
  }


  function Editor(selection, dispatch){

    var code = selection.append("div")
          .call(shadow)
          .node(),
        editor = CodeMirror(code, {
          lineNumbers: false,
          mode: "htmlmixed"
        });

    editor.on("change", function (editor, change){

      // Ignore programmatic changes from editor.setValue().
      if(change.origin === "setValue") return;

      dispatch.call("htmlChange", null, editor.getValue());
    });

    dispatch.on("htmlFetch.editor", function (html){
      editor.setValue(html);
    });
  }


  function Runner(selection, dispatch){

    var iframe = selection.append("iframe")
      .style("position", "fixed")
      .style("top", "0px")
      .style("right", "0px")
      .style("background-color", "white")
      .style("z-index", "3") // CodeMirror's z-index is 2
      .attr("width", "960") // 960 X 500 is standard for bl.ocks.org
      .attr("height", "500")
      .attr("frameborder", "0px")
      .attr("marginwidth", "0")
      .attr("marginheight", "0")
      .attr("scrolling", "no")
      .call(shadow);

    dispatch.on("htmlChange.runner", function (html){
      iframe.attr("srcdoc", html);
    });
  }

  
  function Server(dispatch){
    d3.request("example.html").get(function (xhr){
      var html = xhr.responseText;
      dispatch.call("htmlFetch", null, html);
      dispatch.call("htmlChange", null, html);
    });
  }


  // Listen for global key presses.
  window.addEventListener("keydown", function (event){
    var S = 83;

    // Save the content to the server on CTRL + S
    if(event.ctrlKey && event.which === S){

      // Without this, the browser will try to save the page.
      event.preventDefault();

      // Prepare the body of the POST request.
      var data = {
        content: editor.getValue()
      };

      // Issue a POST request to the server API.
      d3.request("save")
        .header("Content-Type", "application/json")
        .post(JSON.stringify(data), function (){
          d3.select("body")
            .append("div")
              .style("text-align", "center")
              .style("position", "fixed")
              .style("left", "0px")
              .style("right", "0px")
              .style("top", (window.innerHeight / 2 - 100) + "px")
              .style("z-index", 4)
              .style("font-size", "10em")
              .style("font-family", "Sans-Serif")
              .style("text-shadow", "0px 0px 5px white")
              .text("Saved!")
            .transition().duration(1000)
              .style("opacity", 0)
              .remove();
        });
      }
  });

  // Adds a shadow effect to the given D3 selection.
  // Inspired by Material Design "Cards".
  function shadow(selection){
    return selection.style("box-shadow", "1px 1px 4px grey");
  }
}());

    </script>
  </body>
</html>
